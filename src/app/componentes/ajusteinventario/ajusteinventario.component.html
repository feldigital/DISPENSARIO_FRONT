<div class="container mt-4">
    <form [formGroup]="generalForm" class="w-100">
        <div class="form-row">
                
            <div class="row">               
    
                <!-- Columna para los demás campos -->
                <div class="col-md-6">
                    <!-- Fecha de despacho -->
                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label">Fecha del ajuste</label>
                        <div class="col-sm-8">
                            <input type="date" formControlName="fechaAjuste" class="form-control" [max]="hoy">
                        </div>
                    </div>
    
                    <!-- Bodega Origen -->
                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label">Bodega a ajustar</label>
                        <div class="col-sm-8">
                            <select class="form-select" formControlName="bodegaAjuste" required (change)="onBodegaChange()">
                                <option selected value="0">Seleccione la bodega a ajustar</option>
                                <option *ngFor="let item of listaregistrosBodega" [ngValue]="item.idBodega">
                                    {{item.nombre}} - {{item.puntoEntrega}}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label">Fecha del inventario</label>
                        <div class="col-sm-8">
                            <input type="date" formControlName="fechaInventario" class="form-control" [max]="hoy">
                        </div>
                    </div>
       
                     
                     <div class="form-group row">
                        <label class="col-sm-4 col-form-label">Funcionario que inventario</label>
                        <div class="col-sm-8">
                            <input type="text" formControlName="funcionarioInventario" class="form-control" placeholder="Ingrese nombre">
                        </div>
                    </div>

                   


                </div>

                <div class="col-md-6">
                <!-- Botones -->
            <div class="form-row mt-3">
                <div *ngIf ="tieneAcceso(4)" class="col-md-6">
                    <button class="btn btn-outline-primary w-50" (click)="create()">
                        <i class="far fa-save"></i> {{this.nombrebtn}}
                    </button>
                </div>
                <div *ngIf ="tieneAcceso(4)" class="col-md-6">
                    <button class="btn btn-outline-primary w-50 mt-2" (click)="procesarAjusteInventario()">Procesar ajustes</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-primary w-50 mt-2" [routerLink]="['/menu/verajusteinventario']">Ver ajustes</button>
                </div>
                <div class="file-upload mt-2" *ngIf="importar">
                    <input type="file" (change)="onFileChange($event)" accept=".xlsx, .xls" />
                </div>
            </div>
                </div>

                 <!-- Observaciones -->
                 <div class="form-group row mt-2">
                    <label class="col-sm-3 col-form-label">Motivos del ajuste</label>
                    <div class="col-sm-9">
                        <textarea formControlName="observacionAjuste" class="form-control" 
                        placeholder="Ingrese un detalle completo que describa, el o los motivos del ajuste"></textarea>
                    </div>
                </div>
            </div>
    
            
        </div>       
   
    <div class="text-container">
        <div class="input-group mb-2 align-center">
             <span class="input-group-text bg-transparent">
                <mat-icon [ngStyle]="{'color':'#009A94'}">zoom_in</mat-icon>
            </span>
            <input type="text" formControlName="listFilter" class="form-control border-end-0 search-input"
                placeholder="Buscar por nombre del medicamento">               

                
                <!-- Checkbox separado con margen -->
    <div class="form-group d-flex align-items-center ms-3">
        <input id="portabilidad" class="form-check-input me-2" type="checkbox" formControlName="soloajuste"
            (change)="onAjuste($event)">
        <label class="form-check-label" for="portabilidad">Ver solo los medicamentos en ajuste</label>
    </div>
               

        </div>
    </div>
</form>

 <!-- Mensaje sin registros -->
 <div class="alert alert-info my-4" *ngIf="listaregistrosBodega?.length <= 0">
    No hay registros para mostrar!
</div>

<!-- Tabla de Ítems -->
<div *ngIf="listaregistrosBodega?.length > 0">

   

    <table class="table table-striped table-hover table-sm">
        <thead class="thead-colored">
            <tr>
                <th>Item</th>              
                <th>ID</th>
                <th>Nombre</th>
                <th>Forma Farmacéutica</th>
                <th>Existencia en el sistema actual</th>
                <th>Existencia en el sistema durante el inventario</th>
                <th>Existencia fisica en el inventario</th>
                <th>Cantidad a ajustar +/- por inventario</th>
                <th>Gestión</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let itemt of listaItemsFiltro; let i = index">
                <td>{{i + 1}}</td>     
                <td>{{itemt.idMedicamento}}</td>
                <td>{{primerasmayusculas(itemt.nombre)}}</td>
                <td>{{primerasmayusculas(itemt.forma)}}</td>
                <td  [ngClass]="{'text-danger fw-bold': (itemt.cantidad + itemt.cantidadAjuste) < 0 }">
                     {{ itemt.cantidad }}
                     <mat-icon *ngIf="(itemt.cantidad + itemt.cantidadAjuste) < 0" class="ms-1">warning</mat-icon></td>  
                <td class="text-center"> <div *ngIf="itemt.editing">
                    <input type="number" [(ngModel)]="itemt.cantidadSistema" placeholder="Cantidad en sistema inventario"
                        class="form-control mb-1" />                      
                </div>
                <div *ngIf="!itemt.editing">
                    {{itemt.cantidadSistema}}
                </div></td>                     
                <td class="text-center"> <div *ngIf="itemt.editing">
                    <input type="number" [(ngModel)]="itemt.cantidadFisica" placeholder="Cantidad física"
                        class="form-control mb-1" />                      
                </div>
                <div *ngIf="!itemt.editing">
                    {{itemt.cantidadFisica}}
                </div></td>            
                <td class="text-center">
                    <div *ngIf="itemt.editing">
                        <input type="number" [(ngModel)]="itemt.cantidadAjuste" placeholder="Cantidad a ajustar +/-"
                            class="form-control mb-1" />                      
                    </div>
                    <div *ngIf="!itemt.editing" [ngClass]="{'text-danger': itemt.cantidadAjuste < 0, 'text-success': itemt.cantidadAjuste > 0}">
                        {{itemt.cantidadAjuste}}
                    </div>
                </td>
                <td>
                    <mat-icon *ngIf="!itemt.estado && !itemt.editing" title="Editar cantidad"
                        class="pointer-cursor" title="Editar cantidad" [ngStyle]="{'color':'#009A94'}"
                        (click)="editarMedicamentoAjusteInventario(itemt)">edit</mat-icon>
                    
                        <mat-icon *ngIf="!itemt.estado  && itemt.cantidadAjuste != 0" title="Eliminar cantidad"
                            class="pointer-cursor" title="Eliminar cantidad a ajustar" [ngStyle]="{'color':'red'}"  
                        (click)="quitarMedicamentoAjusteInventario(itemt.idMedicamento)">delete_sweep</mat-icon>

                    <mat-icon *ngIf="!itemt.estado && itemt.editing" title="Cancelar" class="pointer-cursor"
                        title="Cancelar edición" [ngStyle]="{'color':'orange'}"
                        (click)="cancelEdicion(itemt)">clear</mat-icon>

                    <mat-icon *ngIf="!itemt.estado && itemt.editing" title="Guardar cantidad" class="pointer-cursor"
                        title="Fijar cantidad" [ngStyle]="{'color':'#009A94'}"
                        (click)="guardarMedicamentoAjusteInventario(itemt)">check</mat-icon>

                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>
