<div class="container mt-2">
    <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start">
        <mat-tab label="Agregar o quitar">
            <div [formGroup]="generalForm">
                <div class="mb-2">
                    <div class="text-container">
                        <div [formGroup]="generalForm" class="input-group mb-2 align-center">

                            <mat-form-field appearance="fill" class="w-100">
                                <mat-label>Digite y seleccione el nombre del medicamento a verificar
                                </mat-label>
                                <input type="text" matInput formControlName="medicamento"
                                    [matAutocomplete]="automedicamento" />
                                <mat-autocomplete #automedicamento="matAutocomplete"
                                    (optionSelected)="seleccionarMedicamento($event)">
                                    <mat-option *ngFor="let option of medicamentosFiltrados" [value]="option">
                                        {{ option.nombre }}
                                    </mat-option>
                                </mat-autocomplete>
                            </mat-form-field>

                        </div>
                    </div>
                </div>

                <div *ngIf="verItem">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="thead-gradient-d">
                            <tr>
                                <th>ID</th>
                                <th>CUM</th>
                                <th>Medicamento</th>
                                <th>Presentación</th>
                                <th>Valor de Compra</th>
                                <th>Contrato</th>
                                <th>Valor Contratado</th>
                                <th>Descuento</th>
                                <th>Gestión</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ medicamentoActual?.idMedicamento}}</td>
                                <td>{{ medicamentoActual?.codigoCum}}</td>
                                <td>{{ medicamentoActual?.nombre}}</td>
                                <td>{{ medicamentoActual?.forma?.nombre }}</td>
                                <td>{{ '$ ' + (medicamentoActual?.valor | number:'1.0-0') }}</td>
                                <td> <select class="form-select uniform-control" formControlName="contrato">
                                        <option selected value="">Seleccionar contrato</option>
                                        <option *ngFor="let item of listaEps" [ngValue]="item.codigo">{{item.nombre}}
                                        </option>
                                    </select> </td>
                                <td> <input type="text" formControlName="valor"
                                        class="form-control border-end-0 search-input"
                                        placeholder="Digite valor contratado"> </td>
                                <td><input type="text" formControlName="descuento"
                                        class="form-control border-end-0 search-input" placeholder="Digite descuento">
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary" title="Agregar medicamento al contrato"
                                        (click)="validarYGuardarMedicamentoContratado()">
                                        Agregar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="alert alert-info my-2" *ngIf="listaItemEps?.length == 0">
                El medicamento no esta asociado a ningun contrato, recuerde solo se puede prescribir al paciente que
                tenga el contrato!
            </div>

            <div *ngIf="listaItemEps?.length > 0">

                <div class="col-12 text-center">
                    <span class="fw-bold">LISTADO DE CONTRATOS DONDE ESTA ASIGNADO EL MEDICAMENTO </span>

                </div>

                <table class="table table-striped table-hover table-sm">
                    <thead class="thead-colored">
                        <tr>
                            <th>Item</th>
                            <th>CUM</th>
                            <th>Nombre</th>
                            <th>Presentación</th>
                            <th>Contrato</th>
                            <th>Descripción</th>
                            <th>Valor Contratado</th>
                            <th>Descuento</th>
                            <th>Gestión</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let itemt of listaItemEps let i= index">
                            <td>{{i+1}}</td>
                            <td>{{itemt.codigoCum}}</td>
                            <td>{{itemt.nombre}}</td>
                            <td>{{itemt.viaNombre}}</td>
                            <td>{{itemt.concentracion}}</td>
                            <td>{{itemt.principioActivo}}</td>
                            <td>{{ ((itemt.valor ?? 0) | currency) }}</td>
                            <td>{{ (itemt.descuento ?? 0) + ' %' }}</td>
                            <td>
                                <mat-icon class="pointer-cursor" title="Actualizar valores"
                                    [ngStyle]="{'color':'#009A94'}">
                                    edith</mat-icon>

                                <mat-icon class="pointer-cursor" title="Eliminar item del contrato"
                                    [ngStyle]="{'color':'red'}" (click)="quitarMedicamentoContrato(itemt)">
                                    clear</mat-icon>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </mat-tab>
        
        <mat-tab label="Consultar contratación">

            <div class="container" [formGroup]="generalForm">
                <!-- Fila 1: Contrato + Botones -->
                <div class="row g-2 align-items-end mb-2">
                  <div class="col-md-6">
                    <label class="form-label mb-1 fw-bold">Seleccione la contratación</label>
                    <select class="form-select form-select-sm" formControlName="contrato">
                      <option value="">Seleccionar contrato</option>
                      <option *ngFor="let item of listaEps" [ngValue]="item.codigo">{{ item.nombre }}</option>
                    </select>
                  </div>
              
                  <div class="col-md-3 d-flex gap-2">
                    <button type="button" class="btn btn-info btn-sm flex-fill d-flex align-items-center justify-content-center"
                      (click)="consultarContratacion()">
                      <mat-icon class="me-1">search</mat-icon> Consultar
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm flex-fill d-flex align-items-center justify-content-center"
                      (click)="exportarExcelContratacion()">
                      <mat-icon class="me-1">file_download</mat-icon> Exportar XLSX
                    </button>
                  </div>
                </div>
              
                <!-- Fila 2: Buscador + Alerta -->
                <div class="row g-2 align-items-end">
                  <div class="col-md-8">
                    <label class="form-label mb-1 fw-bold">Buscar medicamento</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text bg-white border-end-0">
                        <mat-icon class="text-info">search</mat-icon>
                      </span>
                      <input type="text" formControlName="listFilter" class="form-control border-start-0"
                        placeholder="Ingrese el nombre del medicamento" />
                    </div>
                  </div>
              
                  <div class="col-md-4">
                    <div class="alert alert-info text-center py-2 mb-0">
                      <small><strong>Moléculas contratadas:</strong> {{ listaItemEps?.length || 0 }}</small>
                    </div>
                  </div>
                </div>
              </div>
              


                <div class="alert alert-info my-2" *ngIf="listaItemEps?.length == 0">
                    No hay medicamentos, asociados a este contrato!
                </div>

                <div *ngIf="listaItemEps?.length > 0">
                    <table class="table table-striped table-hover table-sm mt-2">
                        <thead class="thead-colored">
                            <tr>
                                <th>Item</th>
                                <th>CUM</th>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Presentación</th>
                                <th>Contrato</th>
                                <th>Valor Contratado</th>
                                <th>Descuento</th>
                                <th>Gestión</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let itemt of listaItemEpsFiltro let i= index">
                                <td>{{i+1}}</td>
                                <td>{{itemt.codigoCum}}</td>
                                <td>{{itemt.idMedicamento}}</td>
                                <td>{{itemt.nombre}}</td>
                                <td>{{itemt.viaNombre}}</td>
                                <td>{{itemt.concentracion}}</td>
                                <td>{{ '$ ' + ((itemt.valor ?? 0) | number:'1.0-0') }}</td>
                                <td>{{ (itemt.descuento ?? 0) + ' %' }}</td>
                                <td>
                                    <mat-icon class="pointer-cursor" title="Actualizar valores"
                                        [ngStyle]="{'color':'#009A94'}">
                                        edith</mat-icon>

                                    <mat-icon class="pointer-cursor" title="Eliminar item del contrato"
                                        [ngStyle]="{'color':'red'}" (click)="quitarMedicamentoContrato(itemt)">
                                        clear</mat-icon>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
           
        </mat-tab>
        <mat-tab label="Importar contratación"> En proceso </mat-tab>
    </mat-tab-group>

</div>