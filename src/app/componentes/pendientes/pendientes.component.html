<div class="container mt-2">

  <form [formGroup]="generalForm" class="px-2">
    <div class="row align-items-end g-2 mb-2">
      <!-- Selector de Bodega -->
      <div class="col-md-4">
        <label class="form-label mb-1 fw-bold">Bodega de pendiente</label>
        <select class="form-select form-select-sm" formControlName="idBodega">
          <option selected value="0">TODAS LAS BODEGAS</option>
          <option *ngFor="let item of listaregistros" [ngValue]="item.idBodega">
            {{ item.nombre }}
          </option>
        </select>
      </div>

      <!-- Rango de Fechas -->
      <div class="col-md-3">
        <label class="form-label mb-1 fw-bold">Rango de fechas</label>
        <div class="d-flex gap-1">
          <input type="date" formControlName="fechainicial" class="form-control form-control-sm">
          <span class="px-1 text-muted">al</span>
          <input type="date" formControlName="fechafinal" class="form-control form-control-sm">
        </div>
      </div>

      <!-- Botón Buscar -->
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-info w-100 d-flex align-items-center justify-content-center"
          (click)="buscarRegistro(parametro)">
          <mat-icon class="me-1">search</mat-icon> Buscar
        </button>
        <button type="button" class="btn  w-100 d-flex align-items-center justify-content-center"
          (click)='reportePendientesDetalldos(parametro)'>
          <img src="assets/iconos/excel.svg" alt="icono reporte" width="22" height="22" /> Exportar
        </button>
        
      </div>

      <!-- Alerta: Total moléculas pendiente -->
      <div *ngIf="listaPendienteBodega?.length > 0" class="col-md-3 d-flex align-items-end">
        <div class="alert alert-danger d-flex align-items-center justify-content-center mb-0 w-100 py-2">
          <small>
            <strong>Moléculas con pendientes:</strong> {{ listaPendienteBodega?.length || 0 }}
          </small>
        </div>
      </div>
    </div>

    <!-- Buscador de Medicamento -->
    <div class="row g-2">
      <div class="col-md-12">
        <label class="form-label mb-1 fw-bold">Buscar medicamento</label>
        <div class="d-flex align-items-center">

          <!-- Campo de búsqueda con ícono -->
          <div class="input-group flex-grow-1 me-2">
            <span class="input-group-text bg-white border-end-0">
              <mat-icon class="text-info">search</mat-icon>
            </span>
            <input type="text" formControlName="listFilter" class="form-control form-control-sm border-start-0"
              placeholder="Digite el nombre del medicamento" />
          </div>

          <!-- Checkbox al lado derecho -->
          <div class="form-check d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" formControlName="existenciaPendiente"
              (change)="onMayorExistencia($event)">
            <label for="portabilidad" class="form-check-label small">
              Ver medicamentos con existencias mayor que pendientes <strong>{{mayorExistencia}}</strong>
            </label>
          </div>
        </div>
      </div>
    </div>

  </form>




  <div class="alert alert-info my-2" *ngIf="listaPendienteBodega?.length == 0">
    No hay medicamentos penidientes, asociados a esta bodega en la fecha seleccionada!
  </div>




  <div *ngIf="listaPendienteBodega?.length > 0">
    <table class="table table-striped table-hover table-sm mt-2">
      <thead class="thead-colored">
        <tr>
          <th>Item</th>
          <th>Cum</th>
          <th>ID</th>
          <th>Nombre </th>
          <th>Presentación</th>
          <th>Existencia</th>
          <th>Ult. Fecha Dotación</th>
          <th>Pendiente</th>
          <th>Gestión</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let itemt of listaPendienteBodegaFiltro let i= index">
          <td>{{i+1}}</td>
          <td>{{itemt.cum}}</td>
          <td>{{itemt.idMedicamento}}</td>
          <td>{{itemt.nombre}}</td>
          <td>{{itemt.forma}}</td>
          <td style="color: green; text-align: right;"><strong>{{itemt.cantidad}}</strong></td>
          <td>{{itemt.ultFecIngreso | date: 'dd/MM/YYYY'}}</td>
          <td style="color: red; text-align: right;"><strong>{{itemt.pendiente}}</strong></td>
          <td>

            <div style="display: flex; align-items: center; gap: 2px;">
              <mat-icon class="puntero" title="Ver detalle de pacientes" style="font-size: 18px; color: black;"
                [routerLink]="['/menu/pacientependiente', itemt.idBodega, itemt.idMedicamento, generalForm.value.fechainicial, generalForm.value.fechafinal]">
                people_outline
              </mat-icon>

              <mat-icon *ngIf="tieneAcceso(2) && itemt.cantidad > 0" class="puntero" [matMenuTriggerFor]="menu"
                title="Enviar mensaje" style="font-size: 20px; color: #25D366;">
                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 448 512" fill="currentColor">
                  <path d="M380.9 97.1C339 55.1 283.2 32 224.2 32c-115 0-208 93-208 208 
                                        0 36.7 9.7 72.4 28.1 103.9L2.5 470.1c-2.2 6.5-.4 13.7 4.5 
                                        18.5 3.6 3.6 8.4 5.5 13.1 5.5 2 0 4.1-.3 6-1l119.8-38.2c30.4 
                                        16.6 64.7 25.4 99.1 25.4h.1c115 0 208-93 208-208 
                                        0-55.6-21.6-107.9-60.2-146.2zM224.2 438.6c-30.5 0-60.6-8.2-86.7-23.7l-6.2-3.7-71.2 
                                        22.7 22.9-69.3-4.1-6.4c-17.7-27.6-27-59.5-27-92.2 
                                        0-95.1 77.4-172.4 172.5-172.4 46 0 89.2 17.9 121.7 
                                        50.4s50.3 75.8 50.3 121.6c.1 95.1-77.3 172.6-172.2 
                                        172.6zm101.4-138.1c-5.5-2.8-32.7-16.1-37.8-17.9-5.1-1.9-8.8-2.8-12.6 
                                        2.8s-14.5 17.9-17.8 21.6c-3.3 3.7-6.5 4.2-12 
                                        1.4s-23.4-8.6-44.6-27.4c-16.5-14.7-27.6-32.9-30.8-38.4-3.2-5.6-.3-8.6 
                                        2.4-11.4 2.5-2.6 5.6-6.6 8.4-9.9 2.8-3.3 3.7-5.6 
                                        5.6-9.3s.9-7-0.5-9.9c-1.4-2.8-12.6-30.3-17.3-41.4-4.5-10.8-9.1-9.3-12.6-9.5-3.3-.2-7.1-.2-10.9-.2s-10.1 
                                        1.4-15.4 7c-5.3 5.6-20.2 19.7-20.2 48.1s20.7 55.8 
                                        23.5 59.7c2.8 3.7 40.7 62.1 98.6 87.2 13.8 5.9 
                                        24.6 9.4 33 12 13.9 4.4 26.5 3.8 36.5 2.3 11.1-1.7 
                                        32.7-13.3 37.3-26.2 4.6-12.9 4.6-23.9 3.2-26.2-1.3-2.2-5-3.6-10.5-6.3z" />
                </svg>
              </mat-icon>

              <mat-menu #menu="matMenu">
                <button (click)='mensajesWSPave(itemt.idBodega,itemt.idMedicamento)' mat-menu-item>
                  <mat-icon [ngStyle]="{'color':'red'}">people_outline</mat-icon>
                  <span>Solo pacientes PAVE</span>
                </button>
                <button (click)='mensajesWSTodo(itemt.idBodega,itemt.idMedicamento)' mat-menu-item>
                  <mat-icon [ngStyle]="{'color':'#2BB6D7'}">people_outline</mat-icon>
                  <span>A todos los pacientes</span>
                </button>
              </mat-menu>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>